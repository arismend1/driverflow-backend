--- Running Auto-Migration (migrate_auth_fix.js) ---
[AUTH MIGRATION] Starting on DB: driverflow.db 
ℹ️  drivers.verified exists
ℹ️  drivers.verification_token exists
ℹ️  drivers.verification_expires exists
ℹ️  drivers.reset_token exists
ℹ️  drivers.reset_expires exists
ℹ️  drivers.status exists
ℹ️  drivers.search_status exists
ℹ️  drivers.estado exists
ℹ️  drivers.created_at exists
ℹ️  empresas.verified exists
ℹ️  empresas.verification_token exists
ℹ️  empresas.verification_expires exists
ℹ️  empresas.reset_token exists
ℹ️  empresas.reset_expires exists
ℹ️  empresas.search_status exists
ℹ️  empresas.created_at exists
ℹ️  empresas.legal_name exists
ℹ️  empresas.address_line1 exists
ℹ️  empresas.city exists
ℹ️  empresas.failed_attempts exists
ℹ️  empresas.lockout_until exists
ℹ️  drivers.failed_attempts exists
ℹ️  drivers.lockout_until exists
ℹ️  events_outbox.ticket_id exists
[AUTH MIGRATION] Completed Successfully.
--- Migration Complete ---
{"ts":"2026-01-26T13:42:32.913Z","level":"INFO","msg":"--- Email Processor Started ---","service":"worker","event":"worker_start"}
{"ts":"2026-01-26T13:42:32.914Z","level":"INFO","msg":"DB Config","service":"worker","event":"worker_config","db_path":"driverflow.db ","dry_run":false}
{"ts":"2026-01-26T13:42:32.916Z","level":"INFO","msg":"DB Check OK","service":"api","event":"db_open_ok","count":65}
--- Starting Integrated Email Worker ---
{"ts":"2026-01-26T13:42:32.917Z","level":"INFO","msg":"Worker polling started","service":"api","event":"worker_loop_start","interval_ms":30000}
{"ts":"2026-01-26T13:42:32.917Z","level":"ERROR","msg":"Loop Error","service":"worker","event":"worker_loop_error","err":{"message":"table worker_heartbeat has no column named worker_name","stack":"SqliteError: table worker_heartbeat has no column named worker_name\n    at Database.prepare (C:\\Users\\dj23\\Desktop\\DriverFlow\\driverflow-mvp\\node_modules\\better-sqlite3\\lib\\methods\\wrappers.js:5:21)\n    at Object.startWorker (C:\\Users\\dj23\\Desktop\\DriverFlow\\driverflow-mvp\\process_outbox_emails.js:161:10)\n    at Object.<anonymous> (C:\\Users\\dj23\\Desktop\\DriverFlow\\driverflow-mvp\\server.js:242:17)\n    at Module._compile (node:internal/modules/cjs/loader:1761:14)\n    at Object..js (node:internal/modules/cjs/loader:1893:10)\n    at Module.load (node:internal/modules/cjs/loader:1481:32)\n    at Module._load (node:internal/modules/cjs/loader:1300:12)\n    at TracingChannel.traceSync (node:diagnostics_channel:328:14)\n    at wrapModuleLoad (node:internal/modules/cjs/loader:245:24)\n    at Module.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:154:5)","code":"SQLITE_ERROR"}}
DriverFlow MVP server listening on port 3000
{"ts":"2026-01-26T13:42:38.973Z","level":"INFO","msg":"HTTP Request","service":"api","request_id":"4fdd683e-5847-4d67-8943-fd4817f4a4ab","route":"/healthz","method":"GET","status":200,"duration_ms":"5.34","event":"http_request"}
{"ts":"2026-01-26T13:42:38.979Z","level":"ERROR","msg":"Readiness Check Failed","service":"api","event":"readyz_fail","err":{"message":"no such column: worker_name","stack":"SqliteError: no such column: worker_name\n    at Database.prepare (C:\\Users\\dj23\\Desktop\\DriverFlow\\driverflow-mvp\\node_modules\\better-sqlite3\\lib\\methods\\wrappers.js:5:21)\n    at C:\\Users\\dj23\\Desktop\\DriverFlow\\driverflow-mvp\\server.js:155:23\n    at Layer.handleRequest (C:\\Users\\dj23\\Desktop\\DriverFlow\\driverflow-mvp\\node_modules\\router\\lib\\layer.js:152:17)\n    at next (C:\\Users\\dj23\\Desktop\\DriverFlow\\driverflow-mvp\\node_modules\\router\\lib\\route.js:157:13)\n    at Route.dispatch (C:\\Users\\dj23\\Desktop\\DriverFlow\\driverflow-mvp\\node_modules\\router\\lib\\route.js:117:3)\n    at handle (C:\\Users\\dj23\\Desktop\\DriverFlow\\driverflow-mvp\\node_modules\\router\\index.js:435:11)\n    at Layer.handleRequest (C:\\Users\\dj23\\Desktop\\DriverFlow\\driverflow-mvp\\node_modules\\router\\lib\\layer.js:152:17)\n    at C:\\Users\\dj23\\Desktop\\DriverFlow\\driverflow-mvp\\node_modules\\router\\index.js:295:15\n    at processParams (C:\\Users\\dj23\\Desktop\\DriverFlow\\driverflow-mvp\\node_modules\\router\\index.js:582:12)\n    at next (C:\\Users\\dj23\\Desktop\\DriverFlow\\driverflow-mvp\\node_modules\\router\\index.js:291:5)","code":"SQLITE_ERROR"}}
{"ts":"2026-01-26T13:42:38.980Z","level":"INFO","msg":"HTTP Request","service":"api","request_id":"51900968-74e3-46b1-acc1-1aca5c66a092","route":"/readyz","method":"GET","status":503,"duration_ms":"2.75","event":"http_request"}
{"ts":"2026-01-26T13:42:38.982Z","level":"INFO","msg":"HTTP Request","service":"api","request_id":"e4ce083b-6032-4271-9fed-60cff93f80d5","route":"/metrics","method":"GET","status":200,"duration_ms":"0.89","event":"http_request"}
{"ts":"2026-01-26T13:42:38.985Z","level":"INFO","msg":"HTTP Request","service":"api","request_id":"c18df9aa-1dfa-4d09-b0fd-30db77a3cf4f","route":"/metrics","method":"GET","status":200,"duration_ms":"1.17","event":"http_request"}
{"ts":"2026-01-26T13:43:02.928Z","level":"ERROR","msg":"Loop Error","service":"worker","event":"worker_loop_error","err":{"message":"table worker_heartbeat has no column named worker_name","stack":"SqliteError: table worker_heartbeat has no column named worker_name\n    at Database.prepare (C:\\Users\\dj23\\Desktop\\DriverFlow\\driverflow-mvp\\node_modules\\better-sqlite3\\lib\\methods\\wrappers.js:5:21)\n    at Object.startWorker (C:\\Users\\dj23\\Desktop\\DriverFlow\\driverflow-mvp\\process_outbox_emails.js:161:10)\n    at runNextTicks (node:internal/process/task_queues:64:5)\n    at listOnTimeout (node:internal/timers:567:9)\n    at process.processTimers (node:internal/timers:541:7)","code":"SQLITE_ERROR"}}
{"ts":"2026-01-26T13:43:32.929Z","level":"ERROR","msg":"Loop Error","service":"worker","event":"worker_loop_error","err":{"message":"table worker_heartbeat has no column named worker_name","stack":"SqliteError: table worker_heartbeat has no column named worker_name\n    at Database.prepare (C:\\Users\\dj23\\Desktop\\DriverFlow\\driverflow-mvp\\node_modules\\better-sqlite3\\lib\\methods\\wrappers.js:5:21)\n    at Object.startWorker (C:\\Users\\dj23\\Desktop\\DriverFlow\\driverflow-mvp\\process_outbox_emails.js:161:10)\n    at runNextTicks (node:internal/process/task_queues:64:5)\n    at listOnTimeout (node:internal/timers:567:9)\n    at process.processTimers (node:internal/timers:541:7)","code":"SQLITE_ERROR"}}
