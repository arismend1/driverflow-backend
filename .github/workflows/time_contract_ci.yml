name: Time Contract Integrity

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-time-contract:
    runs-on: ubuntu-latest
    name: Validate Time Logic (Kill-Switch)
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install Dependencies
        run: npm ci || npm install --production=false

      - name: üß™ Run Time Regression Suite
        # MUST PASS. Fails if Kill-Switch triggers or logic breaks.
        run: |
          node tests/test_time_regression.js
          
      - name: üõ°Ô∏è Verify No Date.now() Usage Scanned
        # Grep for prohibited usage (excluding contract/tests)
        run: |
          if grep -r "Date.now()" . --include=*.js --exclude=time_contract.js --exclude-dir=node_modules --exclude=tests/* --exclude=time_provider.js; then
            echo "‚ùå ERROR: Date.now() detected in unauthorized files!"
            exit 1
          fi
          if grep -r "new Date()" . --include=*.js --exclude=time_contract.js --exclude=generate_weekly_invoices.js --exclude=scripts/* --exclude-dir=node_modules --exclude=tests/* --exclude=time_provider.js; then
             # Note: generate_weekly_invoices uses new Date() for weekcalc internally but uses contract for parsing. 
             # We might need to refine this exclusion or rely on the test_time_regression to catch logic errors.
             # For strictness, better to allow grep hits only where manually verified.
             echo "‚ö†Ô∏è WARNING: new Date() detected. Verify it is not used for current time."
          fi
